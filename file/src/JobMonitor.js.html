<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/JobMonitor.js | Maps4News Api Wrapper</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<script src="./inject/script/0-bundle.browser.js"></script><script src="./inject/script/0-sandbox.js"></script><link rel="stylesheet" href="./inject/css/0-sidebar_fix.css"><link rel="stylesheet" href="./inject/css/0-hide_import.css"><meta name="description" content="Maps4News Api Javascript Wrapper"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Maps4News Api Wrapper"><meta property="twitter:description" content="Maps4News Api Javascript Wrapper"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/MapCreatorEU/api-wrapper"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ImageHandler.js~ImageHandler.html">ImageHandler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/JobMonitor.js~JobMonitor.html">JobMonitor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Maps4News.js~Maps4News.html">Maps4News</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/PaginatedResourceListing.js~PaginatedResourceListing.html">PaginatedResourceListing</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/PaginatedResourceWrapper.js~PaginatedResourceWrapper.html">PaginatedResourceWrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/RequestParameters.js~RequestParameters.html">RequestParameters</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ResourceCache.js~ResourceCache.html">ResourceCache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/ResourceLister.js~ResourceLister.html">ResourceLister</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#enums">enums</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/enums/Enum.js~Enum.html">Enum</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DeletedState">DeletedState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-JobMonitorFilter">JobMonitorFilter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ResultStatus">ResultStatus</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#errors">errors</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/AbstractError.js~AbstractClassError.html">AbstractClassError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/AbstractError.js~AbstractError.html">AbstractError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/AbstractError.js~AbstractMethodError.html">AbstractMethodError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/ApiError.js~ApiError.html">ApiError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/NodeError.js~NodeError.html">NodeError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/OAuthError.js~OAuthError.html">OAuthError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/StaticClassError.js~StaticClassError.html">StaticClassError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/UnsupportedCrudError.js~UnsupportedCrudError.html">UnsupportedCrudError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors/ValidationError.js~ValidationError.html">ValidationError</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#oauth">oauth</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/oauth/DummyFlow.js~DummyFlow.html">DummyFlow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/oauth/ImplicitFlow.js~ImplicitFlow.html">ImplicitFlow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/oauth/ImplicitFlowPopup.js~ImplicitFlowPopup.html">ImplicitFlowPopup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/oauth/OAuth.js~OAuth.html">OAuth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/oauth/OAuthToken.js~OAuthToken.html">OAuthToken</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/oauth/PasswordFlow.js~PasswordFlow.html">PasswordFlow</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#proxy">proxy</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/proxy/OrganisationProxy.js~OrganisationProxy.html">OrganisationProxy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/proxy/OwnedResourceProxy.js~OwnedResourceProxy.html">OwnedResourceProxy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/proxy/ResourceProxy.js~ResourceProxy.html">ResourceProxy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/proxy/SimpleResourceProxy.js~SimpleResourceProxy.html">SimpleResourceProxy</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#resources">resources</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Choropleth.js~Choropleth.html">Choropleth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Color.js~Color.html">Color</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Contract.js~Contract.html">Contract</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Dimension.js~Dimension.html">Dimension</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/DimensionSet.js~DimensionSet.html">DimensionSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Domain.js~Domain.html">Domain</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Faq.js~Faq.html">Faq</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Feature.js~Feature.html">Feature</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Font.js~Font.html">Font</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/FontFamily.js~FontFamily.html">FontFamily</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Highlight.js~Highlight.html">Highlight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/InsetMap.js~InsetMap.html">InsetMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Job.js~Job.html">Job</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/JobMonitorRow.js~JobMonitorRow.html">JobMonitorRow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/JobResult.js~JobResult.html">JobResult</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/JobRevision.js~JobRevision.html">JobRevision</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/JobShare.js~JobShare.html">JobShare</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/JobType.js~JobType.html">JobType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Language.js~Language.html">Language</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Layer.js~Layer.html">Layer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Mapstyle.js~Mapstyle.html">Mapstyle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/MapstyleSet.js~MapstyleSet.html">MapstyleSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Notification.js~Notification.html">Notification</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Organisation.js~Organisation.html">Organisation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Permission.js~Permission.html">Permission</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/PlaceName.js~PlaceName.html">PlaceName</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Role.js~Role.html">Role</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Svg.js~Svg.html">Svg</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/SvgSet.js~SvgSet.html">SvgSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/Tag.js~Tag.html">Tag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/User.js~User.html">User</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#resources-base">resources/base</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/base/CrudBase.js~CrudBase.html">CrudBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/base/CrudSetBase.js~CrudSetBase.html">CrudSetBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/base/CrudSetItemBase.js~CrudSetItemBase.html">CrudSetItemBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/resources/base/ResourceBase.js~ResourceBase.html">ResourceBase</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#traits">traits</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/traits/HandlesImages.js~HandlesImages.html">HandlesImages</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/traits/OwnableResource.js~OwnableResource.html">OwnableResource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/src/traits/Trait.js~Trait.html">Trait</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/Logger.js~Logger.html">Logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/StaticClass.js~StaticClass.html">StaticClass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/Unobservable.js~Unobservable.html">Unobservable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getPaginatedRange">getPaginatedRange</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/JobMonitor.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/*
 * BSD 3-Clause License
 *
 * Copyright (c) 2017, MapCreator
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 *  Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 *
 *  Redistributions in binary form must reproduce the above copyright notice,
 *   this list of conditions and the following disclaimer in the documentation
 *   and/or other materials provided with the distribution.
 *
 *  Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
 * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

import {JobMonitorFilter} from &apos;./enums&apos;;
import Maps4News from &apos;./Maps4News&apos;;
import JobMonitorRow from &apos;./resources/JobMonitorRow&apos;;
import {isParentOf} from &apos;./utils/reflection&apos;;
import {encodeQueryString} from &apos;./utils/requests&apos;;

/**
 * Used for monitoring the job queue
 */
export default class JobMonitor {
  /**
   * JobMonitor constructor
   * @param {Maps4News} api - Api instance
   */
  constructor(api) {
    if (!isParentOf(Maps4News, api)) {
      throw new TypeError(&apos;Expected api to be of type Maps4News&apos;);
    }

    this._api = api;

    this._lastUpdate = this._getTimestamp();
    this._data = [];
    this._filterStatus = JobMonitorFilter.DEFAULT;
    this._filterTags = [];
    this._purge = false;
    this._longPoll = true;
    this._skipMaxUpdate = false;
    this._maxAvailible = {};
  }

  /**
   * Contains the current JobMonitor data
   * @returns {Array&lt;JobMonitorRow&gt;} - Job monitor rows
   */
  get data() {
    return this._data;
  }

  /**
   * Get api instance
   * @returns {Maps4News} - Api instance
   */
  get api() {
    return this._api;
  }

  /**
   * Update the job list
   * @returns {Promise&lt;Number, ApiError&gt;} - Resolves with the number of updated rows
   */
  update() {
    if (this.waiting || this._lastUpdate === this._getTimestamp()) {
      return new Promise(resolve =&gt; {
        resolve(0); // Still waiting for the other promise to resolve or we&apos;re sure there is no new data
      });
    }

    // Counter so we don&apos;t have to worry about racing
    this._waiting = 1;

    if (this._purge) {
      this._data = [];
      this._purge = false;
    }

    // First we need to check if we have enough data to begin with
    let rowCountDiff = Math.min(this.maxRows, this.realMaxRows) - this.data.length;

    if (rowCountDiff &lt; 0) {
      // Remove trailing data
      this._data.splice(this.maxRows, this.data.length - this.maxRows);
      rowCountDiff = 0;
    }

    let requestedRowCount = 0;
    const requests = [];
    const skipLongPoll = rowCountDiff &gt; 0;

    while (rowCountDiff &gt; 0) {
      // @todo Either always do 50 or calculate the correct page number and stuff which takes time...
      const perPage = 50; // Math.min(rowCountDiff, 50);
      const page = Math.floor((this.data.length + requestedRowCount) / perPage) + 1;

      this.api.logger.debug(
        `[JobMonitor] have ${this.data.length + requestedRowCount}, Diff: ${rowCountDiff},` +
        `PerPage: ${perPage}, Page: ${page}, Target: ${perPage * page}`,
      );

      const params = {
        // eslint-disable-next-line
        per_page: perPage,
        page,
      };

      if (this.filterTags.length &gt; 0) {
        params.tags = this.filterTags;
      }

      const url = this._baseUrl + &apos;&amp;&apos; + encodeQueryString(params);

      requests.push(this.api.request(url).then(data =&gt; data.map(x =&gt; new JobMonitorRow(this.api, x))));

      requestedRowCount += perPage;
      rowCountDiff -= perPage;
      this._waiting++;
    }

    const out = [];

    // note: Promise.all resolves with the data in the same order as the input
    out.push(Promise.all(requests).then(data =&gt; {
      // Join data
      data = data.reduce((acc, val) =&gt; acc.concat(val), []);

      // Append data
      this._data = this.data.concat(data);

      const oldLength = this.data.length;

      // Remove duplicates
      this._data = this.data.filter((thing, index, self) =&gt;
        index === self.findIndex((t) =&gt; t.id === thing.id),
      );

      // We&apos;re no longer waiting
      this._waiting -= requests.length;

      return data.length - (oldLength - this.data.length);
    }));

    // Fetch updates
    let url = this._baseUrl + &apos;&amp;timestamp=&apos; + Math.floor(this._lastUpdate);

    if (this.longPoll &amp;&amp; !skipLongPoll) {
      url += &apos;&amp;long_poll&apos;;
    }

    this._lastUpdate = this._getTimestamp();

    out.push(this.api
      .request(url)
      .then(data =&gt; data.map(x =&gt; new JobMonitorRow(this.api, x)))
      .then(data =&gt; {
        const lookup = data.map(x =&gt; x.id);
        let updateCount = 0;

        for (let i = 0; i &lt; this._data.length &amp;&amp; lookup.length &gt; 0; i++) {
          const ii = lookup.indexOf(this._data[i].id);

          if (ii !== -1) {
            this._data[i] = data[ii];

            // Remove the data and the lookup entry
            data.splice(ii, 1);
            lookup.splice(ii, 1);
            updateCount++;
          }
        }

        // Prepend new data
        this._data = data.concat(this._data);

        this._waiting--;

        return updateCount;
      }));

    return Promise
      .all(out)
      .then(x =&gt; x.reduce((s, v) =&gt; s + v, 0))
      .then(rowCount =&gt; {
        const droppedRowCount = this.data.length - this.maxRows;

        // Truncate data if needed
        this._data.splice(this.maxRows, this.data.length - this.maxRows);

        if (!this._skipMaxUpdate) {
          this._maxAvailible[this._baseUrl] = this.data.length;
        }

        this.api.logger.debug(`Target: ${this.maxRows}, Actual: ${this.data.length}, Updated: ${rowCount}, Dropped: ${droppedRowCount}, RealMax: ${this.realMaxRows}`);

        this._skipMaxUpdate = false;

        return rowCount;
      }).catch(e =&gt; {
        this._waiting = 0;
        throw e;
      });
  }

  /**
   * If the JobMonitor is waiting for data. Any update request will
   * resolve with false instantly while this is true.
   * @returns {Boolean} - Waiting for data
   */
  get waiting() {
    return this._waiting &gt; 0;
  }

  /**
   * Maximum number of rows to store
   * @returns {number} - Maximum number of rows
   */
  get maxRows() {
    return this._maxRows || Number(process.env.JOB_MONITOR_MAX_ROWS) || 100;
  }

  /**
   * Set the maximum number of rows to store. Updating this value won&apos;t take
   * effect until the {@link JobMonitor#update} method has been called.
   * @param {number} value - Maximum number of rows
   */
  set maxRows(value) {
    value = Number(value);
    value = Math.max(1, value);

    this.api.logger.debug(`Setting maxRows to ${value}. skipping maxUpdate next cycle.`);

    this._skipMaxUpdate = true;
    this._maxAvailible[this._baseUrl] = value;
    this._maxRows = value;
  }

  /**
   * Used to get internal reference max rows
   */
  get realMaxRows() {
    return this._maxAvailible[this._baseUrl] || this.maxRows;
  }

  get _baseUrl() {
    return `/jobs/monitor/${this.filterStatus}?internal=${!this.hideInternal}`;
  }

  /**
   * If internal users should be hidden. Updating this value won&apos;t take
   * effect until the {@link JobMonitor#update} method has been called.
   * @param {boolean} [value=false] - hide internal users
   */
  set hideInternal(value) {
    value = Boolean(value);

    if (this._hideInternal !== value) {
      this._purge = true;
    }

    this._hideInternal = value;
  }

  /**
   * If internal users should be hidden in the data
   * @returns {boolean} - hide internal users
   */
  get hideInternal() {
    return this._hideInternal || false;
  }

  /**
   * Set the filter for the job monitor
   * @param {string} value - Job monitor filter
   * @see JobMonitorFilter
   */
  set filterStatus(value) {
    value = value.toLowerCase();

    if (!JobMonitorFilter.values().includes(value)) {
      throw new TypeError(&apos;Expected value to be property of JobMonitorFilter. Possible options: &apos; + JobMonitorFilter.values().join(&apos;, &apos;));
    }

    if (this._filterStatus !== value) {
      this._purge = true;
    }

    this._filterStatus = value;
  }

  /**
   * get the filter for the job monitor
   * @returns {string} - Job monitor filter
   */
  get filterStatus() {
    return this._filterStatus;
  }

  set filterTags(value) {
    if (Array.isArray(&apos;array&apos;)) {
      let valueType = value.toString();

      if (valueType !== null &amp;&amp; typeof value !== &apos;undefined&apos;) {
        valueType = value.constructor.name;
      }

      throw new TypeError(`Expected value to be of type array got ${valueType}.`);
    }

    this._filterTags = value;
  }

  get filterTags() {
    return this._filterTags;
  }

  /**
   * Returns the time the ::update method was called for the last time.
   * @returns {Date} - Last update
   * @see JobMonitor#update
   */
  get lastUpdate() {
    return new Date(this._lastUpdate * 1000);
  }

  /**
   * Get if long polling should be used
   * @returns {boolean} - If long polling should be used
   */
  get longPoll() {
    return this._longPoll;
  }

  /**
   * Set if long polling should be used
   * @param {boolean} value - If long polling should be used
   */
  set longPoll(value) {
    this._longPoll = Boolean(value);
  }

  _getTimestamp() {
    return Date.now() / 1000;
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
